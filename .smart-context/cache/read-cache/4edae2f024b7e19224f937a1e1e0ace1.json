{
  "content": "import { useState, useEffect, useRef, useMemo, useCallback, memo } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { Plus, X, Columns2, Rows2, Maximize2, Minimize2, Pencil, Copy } from \"lucide-react\";\nimport { useTerminalStore } from \"../../stores/terminalStore\";\nimport { useUIStore } from \"../../stores/uiStore\";\nimport { closePane, getSessionIds } from \"../../lib/layout/layoutUtils\";\nimport { cleanupTerminal } from \"../../lib/terminal/terminalCache\";\nimport { invoke } from \"../../lib/ipc\";\nimport { useConfirmStore } from \"../../stores/confirmStore\";\n\nexport default memo(function TerminalTabs() {\n  const allSessions = useTerminalStore((s) => s.sessions);\n  const activeId = useTerminalStore((s) => s.activeSessionId);\n  const setActive = useTerminalStore((s) => s.setActiveSession);\n  const removeSession = useTerminalStore((s) => s.removeSession);\n  const updateSession = useTerminalStore((s) => s.updateSession);\n  const setShowSpawn = useUIStore((s) => s.setShowSpawnDialog);\n  const activeWorkspaceId = useUIStore((s) => s.activeWorkspaceId);\n  const viewMode = useUIStore((s) => s.viewMode);\n  const setViewMode = useUIStore((s) => s.setViewMode);\n  const setSplitEnabled = useUIStore((s) => s.setSplitEnabled);\n  const terminalMaximized = useUIStore((s) => s.terminalMaximized);\n  const setTerminalMaximized = useUIStore((s) => s.setTerminalMaximized);\n  const focusedPaneSessionId = useUIStore((s) => s.focusedPaneSessionId);\n  const setSplitSpawnContext = useUIStore((s) => s.setSplitSpawnContext);\n  const workspaceLayouts = useUIStore((s) => s.workspaceLayouts);\n  const setWorkspaceLayout = useUIStore((s) => s.setWorkspaceLayout);\n  const terminalGroups = useUIStore((s) => s.terminalGroups);\n  const activeTerminalGroup = useUIStore((s) => s.activeTerminalGroup);\n  const addTerminalGroup = useUIStore((s) => s.addTerminalGroup);\n  const removeTerminalGroup = useUIStore((s) => s.removeTerminalGroup);\n  const setActiveTerminalGroup = useUIStore((s) => s.setActiveTerminalGroup);\n\n  const sessions = useMemo(\n    () => allSessions.filter((s) => s.workspaceId === activeWorkspaceId),\n    [allSessions, activeWorkspaceId]\n  );\n  const groupIds = useMemo(\n    () => activeWorkspaceId ? (terminalGroups[activeWorkspaceId] || []) : [],\n    [activeWorkspaceId, terminalGroups]\n  );\n  const activeGroupId = activeWorkspaceId ? activeTerminalGroup[activeWorkspaceId] : undefined;\n\n  // Context menu for the bar background (split screen toggle)\n  const [barCtxMenu, setBarCtxMenu] = useState<{ x: number; y: number } | null>(null);\n  const barCtxRef = useRef<HTMLDivElement>(null);\n\n  // Context menu for a tab (session list)\n  const [tabCtxMenu, setTabCtxMenu] = useState<{ x: number; y: number; groupId: string } | null>(null);\n  const tabCtxRef = useRef<HTMLDivElement>(null);\n\n  // Context menu for a terminal session (right-click on group tab)\n  const [sessionCtxMenu, setSessionCtxMenu] = useState<{ x: number; y: number; sessionId: string } | null>(null);\n  const sessionCtxRef = useRef<HTMLDivElement>(null);\n\n  // Close context menus on any click outside\n  useEffect(() => {\n    if (!barCtxMenu && !tabCtxMenu && !sessionCtxMenu) return;\n    const close = (e: MouseEvent) => {\n      if (barCtxMenu && barCtxRef.current && !barCtxRef.current.contains(e.target as Node)) {\n        setBarCtxMenu(null);\n      }\n      if (tabCtxMenu && tabCtxRef.current && !tabCtxRef.current.contains(e.target as Node)) {\n        setTabCtxMenu(null);\n      }\n      if (sessionCtxMenu && sessionCtxRef.current && !sessionCtxRef.current.contains(e.target as Node)) {\n        setSessionCtxMenu(null);\n      }\n    };\n    const id = setTimeout(() => document.addEventListener(\"mousedown\", close), 0);\n    return () => {\n      clearTimeout(id);\n      document.removeEventListener(\"mousedown\", close);\n    };\n  }, [barCtxMenu, tabCtxMenu, sessionCtxMenu]);\n\n  // Close session context menu on ESC\n  useEffect(() => {\n    if (!sessionCtxMenu) return;\n    const handler = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setSessionCtxMenu(null);\n    };\n    document.addEventListener(\"keydown\", handler);\n    return () => document.removeEventListener(\"keydown\", handler);\n  }, [sessionCtxMenu]);\n\n  const handleBarContextMenu = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setBarCtxMenu({ x: e.clientX, y: e.clientY });\n  };\n\n  const handleTabContextMenu = (e: React.MouseEvent, groupId: string) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setTabCtxMenu({ x: e.clientX, y: e.clientY, groupId });\n  };\n\n  const handleSplit = (direction: \"horizontal\" | \"vertical\") => {\n    const targetSession = focusedPaneSessionId || activeId;\n    if (targetSession) {\n      setSplitSpawnContext({ sessionId: targetSession, direction });\n      setShowSpawn(true);\n    }\n  };\n\n  const handleCloseSession = (sessionId: string, groupId: string) => {\n    useConfirmStore.getState().showConfirm(\"Close Terminal\", \"Close this terminal?\", () => {\n      const layout = workspaceLayouts[groupId];\n      if (layout) {\n        const newLayout = closePane(layout, sessionId);\n        if (newLayout) {\n          setWorkspaceLayout(groupId, newLayout);\n        } else {\n          setWorkspaceLayout(groupId, { type: \"leaf\", sessionId: null });\n        }\n      }\n      // Kill the PTY process on the backend\n      invoke(\"close_pty\", { id: sessionId }).catch(() => {});\n      // Clean up terminal instance, xterm, and IPC listeners\n      cleanupTerminal(sessionId);\n      removeSession(sessionId);\n    }, { danger: true });\n  };\n\n  const handleCloseAllInGroup = (groupId: string) => {\n    setTabCtxMenu(null);\n    const layout = workspaceLayouts[groupId];\n    const sessionIds = layout ? getSessionIds(layout) : [];\n    for (const sid of sessionIds) {\n      // Kill the PTY process on the backend\n      invoke(\"close_pty\", { id: sid }).catch(() => {});\n      // Clean up terminal instance, xterm, and IPC listeners\n      cleanupTerminal(sid);\n      removeSession(sid);\n    }\n    // If there's only one group, reset to empty leaf. Otherwise remove the group.\n    if (activeWorkspaceId && groupIds.length <= 1) {\n      setWorkspaceLayout(groupId, { type: \"leaf\", sessionId: null });\n    } else if (activeWorkspaceId) {\n      removeTerminalGroup(activeWorkspaceId, groupId);\n    }\n  };\n\n  const handleAddTerminal = () => {\n    if (!activeWorkspaceId) return;\n    addTerminalGroup(activeWorkspaceId);\n    setShowSpawn(true);\n  };\n\n  // Get sessions for a specific group from its layout\n  const getGroupSessionIds = (groupId: string): string[] => {\n    const layout = workspaceLayouts[groupId];\n    return layout ? getSessionIds(layout) : [];\n  };\n\n  // Context menu sessions (for the right-clicked group)\n  const ctxGroupSessions = useMemo(() => {\n    if (!tabCtxMenu) return [];\n    return getGroupSessionIds(tabCtxMenu.groupId)\n      .map((sid) => allSessions.find((s) => s.id === sid))\n      .filter(Boolean);\n  }, [tabCtxMenu, allSessions, workspaceLayouts]);\n\n  return (\n    <div\n      className=\"flex items-center px-3 gap-1 shrink-0 overflow-x-auto\"\n      style={{\n        height: 40,\n        background: \"transparent\",\n        borderBottom: \"1px solid var(--vp-border-panel)\",\n      }}\n      onContextMenu={handleBarContextMenu}\n    >\n      {/* Terminal group tabs */}\n      {groupIds.map((gid, index) => {\n        const isActive = gid === activeGroupId;\n        const groupSessionIds = getGroupSessionIds(gid);\n        const paneCount = groupSessionIds.length;\n        const label = `Terminal ${index + 1}`;\n        const displayLabel = paneCount > 1 ? `${label} (${paneCount})` : label;\n\n        return (\n          <button\n            key={gid}\n            onClick={() => {\n              if (activeWorkspaceId) setActiveTerminalGroup(activeWorkspaceId, gid);\n            }}\n            onContextMenu={(e) => {\n              handleTabContextMenu(e, gid);\n              // Also set session context menu for the focused session in this group\n              const sessionIds = getGroupSessionIds(gid);\n              const targetSessionId = focusedPaneSessionId && sessionIds.includes(focusedPaneSessionId)\n                ? focusedPaneSessionId\n                : sessionIds[0];\n              if (targetSessionId) {\n                setSessionCtxMenu({ x: e.clientX, y: e.clientY, sessionId: targetSessionId });\n              }\n            }}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs whitespace-nowrap group\"\n            style={{\n              background: isActive ? \"var(--vp-bg-surface-hover)\" : \"transparent\",\n              color: isActive ? \"var(--vp-text-primary)\" : \"var(--vp-text-muted)\",\n              borderRadius: 10,\n              transition: \"all 0.25s cubic-bezier(0.16, 1, 0.3, 1)\",\n              fontWeight: isActive ? 500 : 400,\n            }}\n            onMouseEnter={(e) => {\n              if (!isActive) e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\";\n            }}\n            onMouseLeave={(e) => {\n              if (!isActive) e.currentTarget.style.background = \"transparent\";\n            }}\n          >\n            <span\n              style={{\n                width: 5,\n                height: 5,\n                borderRadius: \"50%\",\n                background: isActive ? \"var(--vp-accent-green)\" : \"var(--vp-border-strong)\",\n                flexShrink: 0,\n              }}\n            />\n            <span>{displayLabel}</span>\n            {/* Close group button â€” show when more than 1 group */}\n            {groupIds.length > 1 && (\n              <X\n                size={12}\n                className=\"opacity-0 group-hover:opacity-100\"\n                style={{ color: \"var(--vp-accent-red-text)\", transition: \"opacity 0.2s ease\" }}\n                onClick={(e) => {\n                  e.stopPropagation();\n                  handleCloseAllInGroup(gid);\n                }}\n              />\n            )}\n          </button>\n        );\n      })}\n\n      {/* Add new terminal button */}\n      <button\n        onClick={handleAddTerminal}\n        className=\"flex items-center justify-center\"\n        title=\"New Terminal\"\n        style={{\n          color: \"var(--vp-text-muted)\",\n          width: 28,\n          height: 28,\n          borderRadius: 8,\n          border: \"1px solid var(--vp-border-light)\",\n          background: \"var(--vp-bg-surface)\",\n          transition: \"all 0.25s cubic-bezier(0.16, 1, 0.3, 1)\",\n        }}\n        onMouseEnter={(e) => {\n          e.currentTarget.style.color = \"var(--vp-text-primary)\";\n          e.currentTarget.style.background = \"var(--vp-border-light)\";\n          e.currentTarget.style.borderColor = \"var(--vp-border-strong)\";\n        }}\n        onMouseLeave={(e) => {\n          e.currentTarget.style.color = \"var(--vp-text-muted)\";\n          e.currentTarget.style.background = \"var(--vp-bg-surface)\";\n          e.currentTarget.style.borderColor = \"var(--vp-border-light)\";\n        }}\n      >\n        <Plus size={14} />\n      </button>\n\n      {/* Spacer */}\n      <div className=\"flex-1\" />\n\n      {/* Maximize button */}\n      <button\n        onClick={() => setTerminalMaximized(!terminalMaximized)}\n        title={terminalMaximized ? \"Exit full screen\" : \"Full screen\"}\n        className=\"flex items-center justify-center\"\n        style={{\n          color: \"var(--vp-text-dim)\",\n          width: 28,\n          height: 28,\n          borderRadius: 8,\n          transition: \"all 0.25s cubic-bezier(0.16, 1, 0.3, 1)\",\n        }}\n        onMouseEnter={(e) => {\n          e.currentTarget.style.color = \"var(--vp-text-primary)\";\n          e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\";\n        }}\n        onMouseLeave={(e) => {\n          e.currentTarget.style.color = \"var(--vp-text-dim)\";\n          e.currentTarget.style.background = \"transparent\";\n        }}\n      >\n        {terminalMaximized ? <Minimize2 size={13} /> : <Maximize2 size={13} />}\n      </button>\n\n      {/* Bar context menu (split screen toggle) */}\n      {barCtxMenu &&\n        createPortal(\n          <div\n            ref={barCtxRef}\n            style={{\n              position: \"fixed\",\n              left: barCtxMenu.x,\n              top: barCtxMenu.y,\n              background: \"var(--vp-bg-tertiary)\",\n              border: \"1px solid var(--vp-border-medium)\",\n              borderRadius: 10,\n              padding: 4,\n              zIndex: 9999,\n              minWidth: 180,\n              boxShadow: \"0 8px 24px rgba(0,0,0,0.5)\",\n            }}\n          >\n            <button\n              onClick={() => {\n                setBarCtxMenu(null);\n                if (viewMode === \"split\") {\n                  setSplitEnabled(false);\n                  setViewMode(\"terminal\");\n                } else {\n                  setViewMode(\"split\");\n                }\n              }}\n              className=\"flex items-center gap-2 w-full px-3 py-2\"\n              style={{\n                background: \"transparent\",\n                border: \"none\",\n                borderRadius: 7,\n                cursor: \"pointer\",\n                color: \"var(--vp-text-primary)\",\n                fontSize: 12,\n                textAlign: \"left\",\n                transition: \"background 0.15s\",\n              }}\n              onMouseEnter={(e) =>\n                (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")\n              }\n              onMouseLeave={(e) =>\n                (e.currentTarget.style.background = \"transparent\")\n              }\n            >\n              <Columns2 size={13} style={{ color: \"var(--vp-text-muted)\" }} />\n              <span>\n                {viewMode === \"split\" ? \"Close Split Screen\" : \"Split Screen\"}\n              </span>\n            </button>\n          </div>,\n          document.body\n        )}\n\n      {/* Tab context menu (session list + close all) */}\n      {tabCtxMenu &&\n        createPortal(\n          <div\n            ref={tabCtxRef}\n            style={{\n              position: \"fixed\",\n              left: tabCtxMenu.x,\n              top: tabCtxMenu.y,\n              background: \"var(--vp-bg-tertiary)\",\n              border: \"1px solid var(--vp-border-medium)\",\n              borderRadius: 10,\n              padding: 4,\n              zIndex: 9999,\n              minWidth: 220,\n              boxShadow: \"0 8px 24px rgba(0,0,0,0.5)\",\n            }}\n          >\n            {ctxGroupSessions.map((s) => (\n              <div\n                key={s!.id}\n                className=\"flex items-center justify-between w-full px-3 py-2\"\n                style={{\n                  borderRadius: 7,\n                  cursor: \"default\",\n                  color: focusedPaneSessionId === s!.id ? \"var(--vp-text-primary)\" : \"var(--vp-text-secondary)\",\n                  fontSize: 12,\n                  transition: \"background 0.15s\",\n                }}\n                onMouseEnter={(e) =>\n                  (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")\n                }\n                onMouseLeave={(e) =>\n                  (e.currentTarget.style.background = \"transparent\")\n                }\n              >\n                <div className=\"flex items-center gap-2\">\n                  <span\n                    style={{\n                      width: 5,\n                      height: 5,\n                      borderRadius: \"50%\",\n                      background: focusedPaneSessionId === s!.id ? \"var(--vp-accent-blue)\" : \"var(--vp-border-strong)\",\n                      flexShrink: 0,\n                    }}\n                  />\n                  <span>{s!.title}</span>\n                </div>\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    handleCloseSession(s!.id, tabCtxMenu.groupId);\n                    const remaining = getGroupSessionIds(tabCtxMenu.groupId);\n                    if (remaining.length <= 1) setTabCtxMenu(null);\n                  }}\n                  style={{\n                    background: \"transparent\",\n                    border: \"none\",\n                    cursor: \"pointer\",\n                    color: \"var(--vp-text-dim)\",\n                    padding: 2,\n                    borderRadius: 4,\n                    display: \"flex\",\n                    alignItems: \"center\",\n                    transition: \"color 0.15s\",\n                  }}\n                  onMouseEnter={(e) => (e.currentTarget.style.color = \"var(--vp-accent-red-text)\")}\n                  onMouseLeave={(e) => (e.currentTarget.style.color = \"var(--vp-text-dim)\")}\n                >\n                  <X size={12} />\n                </button>\n              </div>\n            ))}\n\n            {ctxGroupSessions.length > 1 && (\n              <>\n                <div\n                  style={{\n                    height: 1,\n                    background: \"var(--vp-border-light)\",\n                    margin: \"4px 8px\",\n                  }}\n                />\n                <button\n                  onClick={() => handleCloseAllInGroup(tabCtxMenu.groupId)}\n                  className=\"flex items-center gap-2 w-full px-3 py-2\"\n                  style={{\n                    background: \"transparent\",\n                    border: \"none\",\n                    borderRadius: 7,\n                    cursor: \"pointer\",\n                    color: \"var(--vp-accent-red-text)\",\n                    fontSize: 12,\n                    textAlign: \"left\",\n                    transition: \"background 0.15s\",\n                  }}\n                  onMouseEnter={(e) =>\n                    (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")\n                  }\n                  onMouseLeave={(e) =>\n                    (e.currentTarget.style.background = \"transparent\")\n                  }\n                >\n                  <X size={13} />\n                  <span>Close All</span>\n                </button>\n              </>\n            )}\n          </div>,\n          document.body\n        )}\n\n      {/* Session context menu (Rename / Kill / Copy Path) */}\n      {sessionCtxMenu &&\n        createPortal(\n          <div\n            ref={sessionCtxRef}\n            style={{\n              position: \"fixed\",\n              left: sessionCtxMenu.x,\n              top: sessionCtxMenu.y + 8,\n              background: \"var(--vp-bg-surface)\",\n              border: \"1px solid var(--vp-border-light)\",\n              borderRadius: 8,\n              padding: 4,\n              zIndex: 10000,\n              minWidth: 160,\n              boxShadow: \"0 8px 24px rgba(0,0,0,0.4)\",\n            }}\n          >\n            {/* Rename */}\n            <button\n              onClick={() => {\n                const session = allSessions.find((s) => s.id === sessionCtxMenu.sessionId);\n                const newName = window.prompt(\"Rename terminal:\", session?.title ?? \"\");\n                if (newName && newName.trim()) {\n                  updateSession(sessionCtxMenu.sessionId, { title: newName.trim() });\n                }\n                setSessionCtxMenu(null);\n              }}\n              className=\"flex items-center gap-2 w-full px-3 py-2\"\n              style={{\n                background: \"transparent\",\n                border: \"none\",\n                borderRadius: 6,\n                cursor: \"pointer\",\n                color: \"var(--vp-text-primary)\",\n                fontSize: 12,\n                textAlign: \"left\",\n                transition: \"background 0.15s\",\n              }}\n              onMouseEnter={(e) => (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")}\n              onMouseLeave={(e) => (e.currentTarget.style.background = \"transparent\")}\n            >\n              <Pencil size={13} style={{ color: \"var(--vp-text-muted)\" }} />\n              <span>Rename</span>\n            </button>\n\n            {/* Kill Process */}\n            <button\n              onClick={() => {\n                invoke(\"close_pty\", { id: sessionCtxMenu.sessionId }).catch(() => {});\n                cleanupTerminal(sessionCtxMenu.sessionId);\n                removeSession(sessionCtxMenu.sessionId);\n                setSessionCtxMenu(null);\n              }}\n              className=\"flex items-center gap-2 w-full px-3 py-2\"\n              style={{\n                background: \"transparent\",\n                border: \"none\",\n                borderRadius: 6,\n                cursor: \"pointer\",\n                color: \"var(--vp-accent-red-text)\",\n                fontSize: 12,\n                textAlign: \"left\",\n                transition: \"background 0.15s\",\n              }}\n              onMouseEnter={(e) => (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")}\n              onMouseLeave={(e) => (e.currentTarget.style.background = \"transparent\")}\n            >\n              <X size={13} />\n              <span>Kill Process</span>\n            </button>\n\n            {/* Copy Path */}\n            <button\n              onClick={() => {\n                const session = allSessions.find((s) => s.id === sessionCtxMenu.sessionId);\n                if (session?.projectPath) {\n                  navigator.clipboard.writeText(session.projectPath).catch(() => {});\n                }\n                setSessionCtxMenu(null);\n              }}\n              className=\"flex items-center gap-2 w-full px-3 py-2\"\n              style={{\n                background: \"transparent\",\n                border: \"none\",\n                borderRadius: 6,\n                cursor: \"pointer\",\n                color: \"var(--vp-text-primary)\",\n                fontSize: 12,\n                textAlign: \"left\",\n                transition: \"background 0.15s\",\n              }}\n              onMouseEnter={(e) => (e.currentTarget.style.background = \"var(--vp-bg-surface-hover)\")}\n              onMouseLeave={(e) => (e.currentTarget.style.background = \"transparent\")}\n            >\n              <Copy size={13} style={{ color: \"var(--vp-text-muted)\" }} />\n              <span>Copy Path</span>\n            </button>\n          </div>,\n          document.body\n        )}\n    </div>\n  );\n});\n",
  "hash": "4edae2f024b7e19224f937a1e1e0ace1",
  "tokenCount": 4557,
  "timestamp": "2026-02-15T13:19:06.076Z"
}