{
  "content": "import { ipcMain, BrowserWindow } from \"electron\";\nimport { spawnPty, writePty, resizePty, closePty } from \"../utils/pty-manager\";\n\n// Batch PTY output per session: accumulate data and flush every 16ms (~60fps)\nconst outputBuffers = new Map<string, string[]>();\nconst flushTimers = new Map<string, ReturnType<typeof setTimeout>>();\nconst BATCH_INTERVAL = 16; // ms â€” one frame at 60fps\n\nfunction flushOutput(win: BrowserWindow, sessionId: string) {\n  const chunks = outputBuffers.get(sessionId);\n  if (chunks && chunks.length > 0 && !win.isDestroyed()) {\n    win.webContents.send(`pty-output-${sessionId}`, chunks.join(\"\"));\n  }\n  outputBuffers.delete(sessionId);\n  flushTimers.delete(sessionId);\n}\n\nfunction bufferOutput(win: BrowserWindow, sessionId: string, data: string) {\n  const chunks = outputBuffers.get(sessionId);\n  if (chunks) {\n    chunks.push(data);\n  } else {\n    outputBuffers.set(sessionId, [data]);\n  }\n\n  if (!flushTimers.has(sessionId)) {\n    flushTimers.set(\n      sessionId,\n      setTimeout(() => flushOutput(win, sessionId), BATCH_INTERVAL)\n    );\n  }\n}\n\nfunction cleanupBuffers(sessionId: string) {\n  const timer = flushTimers.get(sessionId);\n  if (timer) clearTimeout(timer);\n  outputBuffers.delete(sessionId);\n  flushTimers.delete(sessionId);\n}\n\nexport function registerTerminalHandlers(win: BrowserWindow) {\n  ipcMain.handle(\"spawn_pty\", (_event, args: { id: string; cmd: string; args: string[]; cwd: string }) => {\n    const result = spawnPty(\n      args.id,\n      args.cmd,\n      args.args,\n      args.cwd,\n      80,\n      24,\n      (sessionId, data) => {\n        bufferOutput(win, sessionId, data);\n      },\n      (sessionId, exitCode, signal) => {\n        // Flush any remaining buffered output before sending exit\n        flushOutput(win, sessionId);\n        cleanupBuffers(sessionId);\n        if (!win.isDestroyed()) {\n          win.webContents.send(`pty-exit-${sessionId}`, { exitCode, signal });\n        }\n      }\n    );\n    return result;\n  });\n\n  ipcMain.handle(\"write_pty\", (_event, args: { id: string; data: string }) => {\n    writePty(args.id, args.data);\n  });\n\n  ipcMain.handle(\"resize_pty\", (_event, args: { id: string; cols: number; rows: number }) => {\n    resizePty(args.id, args.cols, args.rows);\n  });\n\n  ipcMain.handle(\"close_pty\", (_event, args: { id: string }) => {\n    cleanupBuffers(args.id);\n    closePty(args.id);\n  });\n}\n",
  "hash": "972c8550b623d45d4471cf7aad9012dc",
  "tokenCount": 536,
  "timestamp": "2026-02-15T13:19:03.054Z"
}